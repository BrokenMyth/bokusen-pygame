# BOKUSEN 项目打包成 EXE 说明

## 方法一：使用自动打包脚本（推荐）

### 步骤：

1. **激活虚拟环境**
   ```bash
   venv\Scripts\activate
   ```

2. **安装打包依赖**
   ```bash
   pip install pyinstaller
   ```

3. **运行打包脚本**
   ```bash
   python build_exe.py
   ```

4. **打包完成后**
   - exe 文件位于：`dist/BOKUSEN.exe`
   - 复制以下文件到 exe 同级目录：
     - `msgothic.ttc`
     - `settings.json`
     - `json/` 文件夹
     - `resource/` 文件夹（如果有下载的资源）

---

## 方法二：手动使用 PyInstaller

### 基本打包命令：

```bash
pyinstaller --name=BOKUSEN --onefile --windowed bokusen_main.py
```

### 完整打包命令（包含资源文件）：

```bash
pyinstaller --name=BOKUSEN \
  --onefile \
  --windowed \
  --clean \
  --noconfirm \
  --add-data=msgothic.ttc;. \
  --add-data=settings.json;. \
  --add-data=json;json \
  --hidden-import=pygame \
  --hidden-import=pygame.mixer \
  --hidden-import=pydub \
  bokusen_main.py
```

### 参数说明：
- `--name=BOKUSEN`：输出文件名为 BOKUSEN.exe
- `--onefile`：打包成单个 exe 文件
- `--windowed`：不显示控制台窗口（调试时可去掉）
- `--clean`：清理旧的构建文件
- `--add-data`：添加资源文件（格式：源路径;目标路径）
- `--hidden-import`：显式导入隐藏模块

---

## 方法三：创建 .spec 文件

创建 `BOKUSEN.spec` 文件：

```python
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['bokusen_main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('msgothic.ttc', '.'),
        ('settings.json', '.'),
        ('json', 'json'),
    ],
    hiddenimports=[
        'pygame',
        'pygame.mixer',
        'pydub',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='BOKUSEN',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon=None,  # 可以添加图标: icon='icon.ico'
)
```

然后运行：
```bash
pyinstaller BOKUSEN.spec
```

---

## 注意事项

### 1. 资源文件路径问题
打包后，PyInstaller 会将资源文件解压到临时目录，需要修改代码中的路径读取方式。

修改 `bokusen_main.py` 开头添加：

```python
import sys
import os

# 获取资源文件的实际路径
def resource_path(relative_path):
    """获取资源文件的绝对路径（兼容开发环境和打包后的exe）"""
    try:
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath(".")

    return os.path.join(base_path, relative_path)
```

然后修改所有资源文件路径：
```python
# 原来：
game_font = pygame.font.Font('msgothic.ttc', 50)

# 改为：
game_font = pygame.font.Font(resource_path('msgothic.ttc'), 50)
```

### 2. FFmpeg 依赖
pydub 需要 ffmpeg，需要确保系统已安装：
- Windows: 下载 ffmpeg 并添加到系统 PATH
- 或将 ffmpeg.exe 放到 exe 同级目录

### 3. 调试模式
如果打包后运行出错，去掉 `--windowed` 参数查看控制台输出：
```bash
pyinstaller --name=BOKUSEN --onefile bokusen_main.py
```

### 4. 文件大小
- 单文件模式 (--onefile) 会生成较大的 exe（约 50-100MB）
- 文件夹模式（默认）会生成多个文件，但启动更快

---

## 常见问题

### Q: 打包后运行报错找不到资源文件
A: 将 msgothic.ttc、settings.json、json/ 等复制到 exe 同级目录

### Q: exe 启动很慢
A: 正常现象，单文件 exe 需要解压资源。使用文件夹模式可提高启动速度。

### Q: 打包后音频播放失败
A: 确保安装了 ffmpeg，或将 ffmpeg.exe 放到 exe 同级目录

### Q: 如何添加图标
A: 准备 icon.ico 文件，添加 `--icon=icon.ico` 参数

---

## 分发建议

打包完成后，创建一个发布文件夹：
```
BOKUSEN/
├── BOKUSEN.exe
├── msgothic.ttc
├── settings.json
├── json/
├── resource/
└── ffmpeg.exe (如果需要)
```

压缩成 zip 文件即可分发。
